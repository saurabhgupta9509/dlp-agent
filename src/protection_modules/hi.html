<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DLP Admin Dashboard</title>
  <style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
    }

    .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }

    /* Login Styles */
    .login-container {
        max-width: 400px;
        margin: 100px auto;
        background: white;
        padding: 40px;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.1);
        text-align: center;
    }

    .login-container h2 {
        margin-bottom: 30px;
        color: #333;
        font-size: 1.8em;
    }

    .form-group {
        margin-bottom: 20px;
        text-align: left;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
    }

    .form-control {
        width: 100%;
        padding: 12px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s ease;
    }

    .form-control:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .btn-login {
        width: 100%;
        padding: 12px;
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-login:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }

    .login-error {
        color: #e74c3c;
        margin-top: 15px;
        padding: 10px;
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        border-radius: 6px;
        display: none;
    }

    /* Dashboard Styles */
    .header {
        background: white;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .header h1 {
        color: #333;
        font-size: 2.5em;
        background: linear-gradient(45deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .nav-tabs {
        display: flex;
        background: white;
        border-radius: 15px;
        padding: 10px;
        margin-bottom: 20px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        overflow-x: auto;
    }

    .nav-tab {
        padding: 12px 24px;
        margin: 0 5px;
        border: none;
        background: transparent;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        color: #666;
        white-space: nowrap;
    }

    .nav-tab.active {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .nav-tab:hover:not(.active) {
        background: #f8f9fa;
        color: #333;
    }

    .tab-content {
        display: none;
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        min-height: 500px;
    }

    .tab-content.active {
        display: block;
        animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .card {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        border-left: 4px solid #667eea;
    }

    .card h3 {
        color: #333;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: white;
        padding: 25px;
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transition: transform 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-5px);
    }

    .stat-number {
        font-size: 2.5em;
        font-weight: bold;
        background: linear-gradient(45deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 10px;
    }

    .stat-label {
        color: #666;
        font-weight: 600;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    th, td {
        padding: 15px;
        text-align: left;
        border-bottom: 1px solid #eee;
    }

    th {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        font-weight: 600;
    }

    tr:hover {
        background: #f8f9fa;
    }

    .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        margin: 2px;
    }

    .btn-primary {
        background: #667eea;
        color: white;
    }

    .btn-danger {
        background: #e74c3c;
        color: white;
    }

    .btn-success {
        background: #27ae60;
        color: white;
    }

    .btn-warning {
        background: #f39c12;
        color: white;
    }

    .btn-info {
        background: #3498db;
        color: white;
    }

    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .hidden {
        display: none;
    }

    .loading {
        text-align: center;
        padding: 40px;
        color: #666;
    }

    .notification-badge {
        background: #e74c3c;
        color: white;
        border-radius: 50%;
        padding: 2px 6px;
        font-size: 12px;
        margin-left: 5px;
    }

    /* Policy Wizard Styles */
    .wizard-container {
        margin-top: 20px;
    }

    .wizard-step {
        display: none;
        padding: 20px;
        background: white;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .wizard-step.active {
        display: block;
    }

    .wizard-navigation {
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
    }

    .protection-category {
        margin-bottom: 30px;
    }

    .policies-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }

    .policy-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        border: 2px solid #e9ecef;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .policy-card:hover {
        border-color: #667eea;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1);
    }

    .policy-card.selected {
        border-color: #667eea;
        background: #f0f4ff;
    }

    .policy-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .policy-header h5 {
        margin: 0;
        color: #333;
    }

    .severity-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.7em;
        font-weight: bold;
    }

    .severity-badge.high {
        background: #e74c3c;
        color: white;
    }

    .severity-badge.medium {
        background: #f39c12;
        color: white;
    }

    .severity-badge.low {
        background: #27ae60;
        color: white;
    }

    .policy-action {
        margin-top: 10px;
        padding: 8px;
        background: #f8f9fa;
        border-radius: 4px;
        font-size: 0.9em;
    }

    /* Alert Styles */
    .alert-item {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        animation: slideIn 0.5s ease;
    }

    .alert-item.critical {
        background: #f8d7da;
        border-color: #f5c6cb;
    }

    .alert-item.high {
        background: #fce4d6;
        border-color: #f8d7c9;
    }

    .alert-filters {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .filter-btn {
        padding: 8px 16px;
        border: 1px solid #ddd;
        border-radius: 20px;
        background: white;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .filter-btn.active {
        background: #667eea;
        color: white;
        border-color: #667eea;
    }

    .action-buttons {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }

    @keyframes slideIn {
        from { opacity: 0; transform: translateX(-20px); }
        to { opacity: 1; transform: translateX(0); }
    }

    /* Agent Selector */
    .agent-selector {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 10px;
    }

    .agent-card {
        background: white;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .agent-info {
        display: flex;
        flex-direction: column;
    }

    .agent-name {
        font-weight: 600;
    }

    .agent-status {
        font-size: 0.8em;
        color: #666;
    }

    .status-active {
        color: #27ae60;
        font-weight: 600;
    }

    .status-inactive {
        color: #e74c3c;
        font-weight: 600;
    }
  </style>
</head>
<body>
<!-- Login Screen -->
<div id="loginScreen">
  <div class="login-container">
    <h2>üîê DLP Admin Login</h2>
    <div class="form-group">
      <label for="username">Username</label>
      <input type="text" id="username" class="form-control" placeholder="Enter username" value="admin">
    </div>
    <div class="form-group">
      <label for="password">Password</label>
      <input type="password" id="password" class="form-control" placeholder="Enter password" value="admin123">
    </div>
    <button class="btn-login" onclick="adminLogin()">Login to Dashboard</button>
    <div id="loginError" class="login-error"></div>

    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; font-size: 12px; color: #666;">
      <strong>Default Credentials:</strong><br>
      Username: <code>admin</code><br>
      Password: <code>admin123</code>
    </div>
  </div>
</div>

<!-- Main Dashboard -->
<div id="dashboard" class="hidden">
  <div class="container">
    <div class="header">
      <h1>üõ°Ô∏è DLP Admin Dashboard</h1>
      <div>
        <span id="adminName">Welcome, Admin</span>
        <button class="btn btn-danger" onclick="logout()" style="margin-left: 15px;">Logout</button>
      </div>
    </div>

    <div class="nav-tabs">
      <button class="nav-tab active" onclick="showTab('overview')">üìä Overview</button>
      <button class="nav-tab" onclick="showTab('agents')">üë• Agents</button>
      <button class="nav-tab" onclick="showTab('policies')">üìú Protection Policies</button>
      <button class="nav-tab" onclick="showTab('alerts')">
        üö® Alerts <span id="alertBadge" class="notification-badge hidden">0</span>
      </button>
    </div>

    <!-- Overview Tab -->
    <div id="overview" class="tab-content active">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number" id="totalAgents">0</div>
          <div class="stat-label">Total Agents</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="activeAgents">0</div>
          <div class="stat-label">Active Agents</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="totalPolicies">0</div>
          <div class="stat-label">Active Policies</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="pendingAlerts">0</div>
          <div class="stat-label">Pending Alerts</div>
        </div>
      </div>

      <div class="card">
        <h3>üìà Recent Activity</h3>
        <div id="recentActivity">
          <div class="loading">Loading recent activity...</div>
        </div>
      </div>
    </div>

    <!-- Agents Tab -->
    <div id="agents" class="tab-content">
      <div class="card">
        <h3>üë• Manage Agents</h3>
        <table>
          <thead>
          <tr>
            <th>ID</th>
            <th>Hostname</th>
            <th>Status</th>
            <th>Last Heartbeat</th>
            <th>Policies</th>
            <th>Actions</th>
          </tr>
          </thead>
          <tbody id="agentsTable">
          <tr><td colspan="6" class="loading">Loading agents...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Policies Tab -->
    <div id="policies" class="tab-content">
      <!-- Policy Assignment Wizard -->
      <div class="card">
        <h3>üõ°Ô∏è DLP Protection Assignment</h3>
        <p>Select pre-built protection policies and assign to agents</p>

        <div class="wizard-container">
          <!-- Step 1: Select Protection Type -->
          <div id="wizardStep1" class="wizard-step active">
            <h4>Step 1: Select Protection Category</h4>
            <div class="form-group">
              <label>Choose protection type:</label>
              <select id="protectionCategory" class="form-control" onchange="loadProtectionPolicies()">
                <option value="">Select Category</option>
                <option value="USB">üíæ USB Protection</option>
                <option value="NETWORK">üåê Network Protection</option>
                <option value="FILE">üìÅ File Protection</option>
              </select>
            </div>
          </div>

          <!-- Step 2: Select Specific Policy -->
          <div id="wizardStep2" class="wizard-step">
            <h4>Step 2: Select Protection Policy</h4>
            <div class="form-group">
              <label>Choose specific policy:</label>
              <div id="policiesContainer">
                <div class="loading">Select a category first...</div>
              </div>
            </div>
          </div>

          <!-- Step 3: Select Agents -->
          <div id="wizardStep3" class="wizard-step">
            <h4>Step 3: Select Agents</h4>
            <div class="form-group">
              <label>Choose which agents to protect:</label>
              <div id="agentsCheckboxList" class="agent-selector">
                <div class="loading">Loading agents...</div>
              </div>
            </div>
          </div>

          <!-- Navigation -->
          <div class="wizard-navigation">
            <button class="btn btn-warning" onclick="previousWizardStep()" id="prevBtn" style="display: none;">‚Üê Previous</button>
            <button class="btn btn-primary" onclick="nextWizardStep()" id="nextBtn">Next ‚Üí</button>
            <button class="btn btn-success" onclick="assignProtectionPolicy()" id="applyBtn" style="display: none;">‚úÖ Assign Protection</button>
          </div>
        </div>
      </div>

      <!-- Current Policies -->
      <div class="card">
        <h3>üìã Active Policy Assignments</h3>
        <table>
          <thead>
          <tr>
            <th>Agent</th>
            <th>Protection Type</th>
            <th>Policy</th>
            <th>Action</th>
            <th>Severity</th>
            <th>Assigned</th>
          </tr>
          </thead>
          <tbody id="activePoliciesTable">
          <tr><td colspan="6" class="loading">Loading active policies...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Alerts Tab -->
    <div id="alerts" class="tab-content">
      <div class="card">
        <h3>üö® Security Alerts</h3>
        <div class="alert-filters">
          <button class="filter-btn active" onclick="filterAlerts('ALL')">All</button>
          <button class="filter-btn" onclick="filterAlerts('USB')">USB</button>
          <button class="filter-btn" onclick="filterAlerts('FILE')">File</button>
          <button class="filter-btn" onclick="filterAlerts('CRITICAL')">Critical</button>
          <button class="filter-btn" onclick="filterAlerts('PENDING')">Pending</button>
        </div>
        <div class="action-buttons">
          <button class="btn btn-primary" onclick="loadAlerts()">üîÑ Refresh</button>
          <button class="btn btn-success" onclick="createTestAlert()">üß™ Create Test Alert</button>
        </div>

        <div id="alertsList" style="margin-top: 20px;">
          <div class="loading">Loading alerts...</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Global variables
  let currentUser = null;
  let currentWizardStep = 1;
  let selectedPolicyId = null;
  let selectedAgents = [];
  let currentAlertFilter = 'ALL';
  let refreshInterval;

  // Authentication Functions
  async function checkAuthStatus() {
      try {
          const response = await fetch('/api/auth/check');
          const result = await response.json();

          if (result.success) {
              currentUser = result.data;
              showDashboard();
          } else {
              showLogin();
          }
      } catch (error) {
          showLogin();
      }
  }

  async function adminLogin() {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const errorDiv = document.getElementById('loginError');

      errorDiv.style.display = 'none';
      errorDiv.textContent = '';

      if (!username || !password) {
          showError('Please enter both username and password');
          return;
      }

      try {
          const response = await fetch('/api/auth/login', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ username, password })
          });

          const result = await response.json();

          if (result.success) {
              currentUser = result.data;
              showDashboard();
          } else {
              showError(result.message || 'Login failed');
          }
      } catch (error) {
          showError('Network error: ' + error.message);
      }
  }

  async function logout() {
      try {
          await fetch('/api/auth/logout', { method: 'POST' });
      } catch (error) {
          console.error('Logout error:', error);
      } finally {
          currentUser = null;
          showLogin();
      }
  }

  function showDashboard() {
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('dashboard').classList.remove('hidden');

      if (currentUser) {
          document.getElementById('adminName').textContent = `Welcome, ${currentUser.username}`;
      }

      loadDashboardData();
      startAutoRefresh();
  }

  function showLogin() {
      document.getElementById('dashboard').classList.add('hidden');
      document.getElementById('loginScreen').classList.remove('hidden');
      stopAutoRefresh();
  }

  function showError(message) {
      const errorDiv = document.getElementById('loginError');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
  }

  // Tab Management
  function showTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));

      document.getElementById(tabName).classList.add('active');
      document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');

      switch(tabName) {
          case 'agents': loadAgents(); break;
          case 'policies': 
              loadProtectionPolicies(); 
              loadAgentsForWizard(); 
              loadActivePoliciesTable();
              break;
          case 'alerts': loadAlerts(); break;
      }
  }

  // Dashboard Data Loading
  async function loadDashboardData() {
      await Promise.all([
          loadOverviewStats(),
          loadAgents(),
          loadAlerts()
      ]);
  }

  async function loadOverviewStats() {
      try {
          const [agentsRes, alertsRes] = await Promise.all([
              fetch('/api/admin/agents'),
              fetch('/api/admin/alerts/pending')
          ]);

          const agents = await agentsRes.json();
          const alerts = await alertsRes.json();

          if (agents.success) {
              const totalAgents = agents.data.length;
              const activeAgents = agents.data.filter(a => a.status === 'ACTIVE').length;

              document.getElementById('totalAgents').textContent = totalAgents;
              document.getElementById('activeAgents').textContent = activeAgents;
          }

          if (alerts.success) {
              const pendingCount = alerts.data.length;
              document.getElementById('pendingAlerts').textContent = pendingCount;

              const badge = document.getElementById('alertBadge');
              badge.textContent = pendingCount;
              pendingCount > 0 ? badge.classList.remove('hidden') : badge.classList.add('hidden');
          }
      } catch (error) {
          console.error('Error loading stats:', error);
      }
  }

  // Agents Management
  async function loadAgents() {
    try {
        console.log("üì° Calling /api/admin/agents...");

        const response = await fetch('/api/admin/agents');
        console.log("Response status:", response.status);

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();
        console.log("API Response:", result);

        if (result.success) {
            const tbody = document.getElementById('agentsTable');
            tbody.innerHTML = result.data.map(agent => `
                <tr>
                    <td>${agent.id}</td>
                    <td>${agent.hostname || agent.username}</td>
                    <td><span class="status-${agent.status.toLowerCase()}">${agent.status}</span></td>
                    <td>${agent.lastHeartbeat ? new Date(agent.lastHeartbeat).toLocaleString() : 'Never'}</td>
                    <td>${agent.policyCount || 0}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="updateAgentStatus(${agent.id}, '${agent.status === 'ACTIVE' ? 'INACTIVE' : 'ACTIVE'}')">
                            ${agent.status === 'ACTIVE' ? 'Deactivate' : 'Activate'}
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteAgent(${agent.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
        } else {
            console.error("API returned error:", result.message);
            document.getElementById('agentsTable').innerHTML = `<tr><td colspan="6">Error: ${result.message}</td></tr>`;
        }
    } catch (error) {
        console.error("‚ùå Error loading agents:", error);
        document.getElementById('agentsTable').innerHTML = `<tr><td colspan="6">Failed to load agents: ${error.message}</td></tr>`;
    }
}

  async function updateAgentStatus(agentId, newStatus) {
      try {
          const response = await fetch(`/api/admin/agents/${agentId}/status?status=${newStatus}`, {
              method: 'PUT'
          });

          const result = await response.json();

          if (result.success) {
              loadAgents();
              loadOverviewStats();
          } else {
              alert('Error: ' + result.message);
          }
      } catch (error) {
          alert('Error updating agent: ' + error.message);
      }
  }

  async function deleteAgent(agentId) {
      if (confirm('Are you sure you want to delete this agent?')) {
          try {
              const response = await fetch(`/api/admin/agents/${agentId}`, {
                  method: 'DELETE'
              });

              const result = await response.json();

              if (result.success) {
                  loadAgents();
                  loadOverviewStats();
              } else {
                  alert('Error: ' + result.message);
              }
          } catch (error) {
              alert('Error deleting agent: ' + error.message);
          }
      }
  }

  // Policy Management
  function selectPolicy(policyCode, element) {
      selectedPolicyId = policyCode;
      
      // Remove selected class from all policy cards
      document.querySelectorAll('.policy-card').forEach(card => {
          card.classList.remove('selected');
      });
      
      // Add selected class to clicked card
      element.classList.add('selected');
  }

  async function loadProtectionPolicies() {
      const category = document.getElementById('protectionCategory').value;
      if (!category) return;

      try {
          console.log("üìã Loading protection policies for category:", category);

          const response = await fetch('/api/admin/protection-policies');
          const result = await response.json();

          console.log("Protection policies response:", result);

          if (result.success) {
              const policies = result.data[category] || [];
              const container = document.getElementById('policiesContainer');

              console.log(`Found ${policies.length} policies for ${category}:`, policies);

              if (policies.length === 0) {
                  container.innerHTML = `
                      <div style="text-align: center; padding: 20px; color: #666;">
                          <p>‚ùå No policies available for this category</p>
                          <p style="font-size: 12px; margin-top: 10px;">
                              Check if pre-built policies were created in backend logs
                          </p>
                      </div>
                  `;
                  return;
              }

              container.innerHTML = policies.map(policy => `
                  <div class="policy-card" onclick="selectPolicy('${policy.policyCode}', this)">
                      <div class="policy-header">
                          <h5>${policy.name}</h5>
                          <span class="severity-badge ${policy.severity.toLowerCase()}">${policy.severity}</span>
                      </div>
                      <p>${policy.description}</p>
                      <div class="policy-action">
                          <strong>Action:</strong> ${policy.action} | <strong>Target:</strong> ${policy.target}
                      </div>
                      <div style="margin-top: 8px; font-size: 0.8em; color: #666;">
                          Code: ${policy.policyCode} | Type: ${policy.policyType}
                      </div>
                  </div>
              `).join('');
          } else {
              console.error("Failed to load protection policies:", result.message);
              container.innerHTML = `<p>Error loading policies: ${result.message}</p>`;
          }
      } catch (error) {
          console.error('Error loading protection policies:', error);
          const container = document.getElementById('policiesContainer');
          container.innerHTML = `<p>Error: ${error.message}</p>`;
      }
  }

  async function loadAgentsForWizard() {
      try {
          const response = await fetch('/api/admin/agents');
          const result = await response.json();

          if (result.success) {
              const container = document.getElementById('agentsCheckboxList');
              container.innerHTML = result.data.map(agent => `
                  <div class="agent-card">
                      <div class="agent-info">
                          <div class="agent-name">${agent.hostname || agent.username}</div>
                          <div class="agent-status">ID: ${agent.id} | Status: ${agent.status}</div>
                      </div>
                      <input type="checkbox" id="agent-${agent.id}" value="${agent.id}" onchange="updateSelectedAgents(${agent.id})">
                  </div>
              `).join('');
          }
      } catch (error) {
          console.error('Error loading agents for wizard:', error);
      }
  }

  function updateSelectedAgents(agentId) {
      const checkbox = document.getElementById(`agent-${agentId}`);
      if (checkbox.checked) {
          selectedAgents.push(agentId);
      } else {
          selectedAgents = selectedAgents.filter(id => id !== agentId);
      }
  }

  // Wizard Navigation
  function nextWizardStep() {
      if (currentWizardStep === 1) {
          const category = document.getElementById('protectionCategory').value;
          if (!category) {
              alert('Please select a protection category');
              return;
          }
      } else if (currentWizardStep === 2) {
          if (!selectedPolicyId) {
              alert('Please select a protection policy');
              return;
          }
      } else if (currentWizardStep === 3) {
          if (selectedAgents.length === 0) {
              alert('Please select at least one agent');
              return;
          }
      }

      document.getElementById(`wizardStep${currentWizardStep}`).classList.remove('active');
      currentWizardStep++;
      document.getElementById(`wizardStep${currentWizardStep}`).classList.add('active');
      updateWizardNavigation();
  }

  function previousWizardStep() {
      document.getElementById(`wizardStep${currentWizardStep}`).classList.remove('active');
      currentWizardStep--;
      document.getElementById(`wizardStep${currentWizardStep}`).classList.add('active');
      updateWizardNavigation();
  }

  function updateWizardNavigation() {
      document.getElementById('prevBtn').style.display = currentWizardStep > 1 ? 'block' : 'none';
      document.getElementById('nextBtn').style.display = currentWizardStep < 3 ? 'block' : 'none';
      document.getElementById('applyBtn').style.display = currentWizardStep === 3 ? 'block' : 'none';
  }

  async function assignProtectionPolicy() {
      if (selectedAgents.length === 0) {
          alert('Please select at least one agent');
          return;
      }

      if (!selectedPolicyId) {
          alert('Please select a protection policy');
          return;
      }

      try {
          console.log("Assigning policy:", selectedPolicyId, "to agents:", selectedAgents);

          const response = await fetch('/api/admin/assign-protection', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                  policyCode: selectedPolicyId,
                  agentIds: selectedAgents
              })
          });

          const result = await response.json();

          if (result.success) {
              alert(`‚úÖ Protection policy assigned to ${selectedAgents.length} agents!`);
              resetWizard();
              loadActivePoliciesTable();
          } else {
              alert('Error: ' + result.message);
          }
      } catch (error) {
          alert('Error assigning protection: ' + error.message);
      }
  }

  // Debug function to check policies
  async function debugPolicies() {
      try {
          console.log("üîç Debug: Checking policies...");

          const response = await fetch('/api/admin/protection-policies');
          const result = await response.json();

          console.log("All protection policies:", result);

          if (result.success) {
              Object.keys(result.data).forEach(category => {
                  console.log(`Category ${category}:`, result.data[category]);
              });
          }
      } catch (error) {
          console.error("Debug error:", error);
      }
  }

  // Call this in your browser console to debug
  window.debugPolicies = debugPolicies;

  function resetWizard() {
      currentWizardStep = 1;
      selectedPolicyId = null;
      selectedAgents = [];

      document.querySelectorAll('.wizard-step').forEach(step => step.classList.remove('active'));
      document.getElementById('wizardStep1').classList.add('active');
      document.getElementById('protectionCategory').value = '';
      document.getElementById('policiesContainer').innerHTML = '<div class="loading">Select a category first...</div>';
      document.getElementById('agentsCheckboxList').innerHTML = '<div class="loading">Loading agents...</div>';

      updateWizardNavigation();
  }

  // Alerts Management
  async function loadAlerts() {
      try {
          const response = await fetch('/api/admin/alerts/pending');
          const result = await response.json();

          const container = document.getElementById('alertsList');

          if (result.success) {
              if (result.data.length === 0) {
                  container.innerHTML = '<p>No pending alerts</p>';
              } else {
                  container.innerHTML = result.data.map(alert => renderAlertCard(alert)).join('');
              }

              // Update badge
              const badge = document.getElementById('alertBadge');
              badge.textContent = result.data.length;
              result.data.length > 0 ? badge.classList.remove('hidden') : badge.classList.add('hidden');
          }
      } catch (error) {
          console.error('Error loading alerts:', error);
      }
  }

  function renderAlertCard(alert) {
      const severityClass = alert.severity ? alert.severity.toLowerCase() : 'medium';
      const isUSB = alert.alertType && alert.alertType.includes('USB');
      const isFile = alert.alertType && alert.alertType.includes('FILE');

      return `
          <div class="alert-item ${severityClass}">
              <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                  <div>
                      <strong>${alert.alertType || 'Unknown Alert'}</strong>
                      <span style="margin-left: 10px; font-size: 0.9em; color: #666;">
                          Agent: ${alert.agent ? alert.agent.username : 'Unknown'}
                      </span>
                  </div>
                  <span style="font-size: 0.9em; color: #666;">
                      ${new Date(alert.createdAt || Date.now()).toLocaleString()}
                  </span>
              </div>
              <div style="margin-top: 10px;">
                  <p><strong>Description:</strong> ${alert.description || 'No description'}</p>
                  ${alert.deviceInfo ? `<p><strong>Device Info:</strong> ${alert.deviceInfo}</p>` : ''}
                  ${alert.fileDetails ? `<p><strong>File Details:</strong> ${alert.fileDetails}</p>` : ''}
              </div>
              <div class="action-buttons">
                  <button class="btn btn-success btn-sm" onclick="handleAlertDecision(${alert.id}, 'ALLOW')">‚úÖ Allow</button>
                  <button class="btn btn-danger btn-sm" onclick="handleAlertDecision(${alert.id}, 'BLOCK')">‚ùå Block</button>
                  <button class="btn btn-info btn-sm" onclick="viewAlertDetails(${alert.id})">üîç Details</button>
              </div>
          </div>
      `;
  }

  function filterAlerts(filter) {
      currentAlertFilter = filter;

      document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');

      // Filter logic would be implemented here
      loadAlerts();
  }

  async function handleAlertDecision(alertId, decision) {
      try {
          const response = await fetch(`/api/admin/alerts/${alertId}/decision?decision=${decision}`, {
              method: 'POST'
          });

          const result = await response.json();

          if (result.success) {
              alert(`Alert ${decision.toLowerCase()}ed successfully!`);
              loadAlerts();
              loadOverviewStats();
          } else {
              alert('Error: ' + result.message);
          }
      } catch (error) {
          alert('Error handling alert: ' + error.message);
      }
  }

  function viewAlertDetails(alertId) {
      alert(`Viewing details for alert ID: ${alertId}`);
  }

  // Active Policies Table
  async function loadActivePoliciesTable() {
      try {
          const response = await fetch('/api/admin/debug/assignments');
          const result = await response.json();

          if (result.success) {
              const container = document.getElementById('activePoliciesTable');
              const assignments = result.data.assignments || [];

              if (assignments.length === 0) {
                  container.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">No policy assignments found</td></tr>';
                  return;
              }

              container.innerHTML = assignments.map(assignment => `
                  <tr>
                      <td>${assignment.user ? assignment.user.username : 'Unknown'}</td>
                      <td>${assignment.policy ? assignment.policy.category : 'N/A'}</td>
                      <td>${assignment.policy ? assignment.policy.name : 'N/A'}</td>
                      <td>${assignment.policy ? assignment.policy.action : 'N/A'}</td>
                      <td>${assignment.policy ? assignment.policy.severity : 'N/A'}</td>
                      <td>${assignment.assignedAt ? new Date(assignment.assignedAt).toLocaleString() : 'N/A'}</td>
                  </tr>
              `).join('');
          }
      } catch (error) {
          console.error('Error loading active policies:', error);
      }
  }

  async function createTestAlert() {
      try {
          const response = await fetch('/api/admin/alerts/create-test?agentId=1&alertType=USB_INSERTION&description=Test+USB+detected&deviceInfo=F:&fileDetails=Test+file+copied', {
              method: 'POST'
          });

          const result = await response.json();

          if (result.success) {
              alert('Test alert created!');
              loadAlerts();
          } else {
              alert('Error: ' + result.message);
          }
      } catch (error) {
          alert('Error creating test alert: ' + error.message);
      }
  }

  // Auto-refresh
  function startAutoRefresh() {
      refreshInterval = setInterval(() => {
          loadOverviewStats();
          const activeTab = document.querySelector('.tab-content.active').id;
          if (activeTab === 'alerts') {
              loadAlerts();
          }
      }, 30000);
  }

  function stopAutoRefresh() {
      if (refreshInterval) {
          clearInterval(refreshInterval);
      }
  }

  // Event Listeners
  document.getElementById('password').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
          adminLogin();
      }
  });

  document.addEventListener('DOMContentLoaded', function() {
      checkAuthStatus();
  });
</script>
</body>
</html>